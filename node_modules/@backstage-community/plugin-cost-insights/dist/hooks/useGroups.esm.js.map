{"version":3,"file":"useGroups.esm.js","sources":["../../src/hooks/useGroups.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, {\n  PropsWithChildren,\n  useContext,\n  useEffect,\n  useState,\n} from 'react';\nimport Alert from '@material-ui/lab/Alert';\nimport { costInsightsApiRef } from '../api';\nimport { MapLoadingToProps, useLoading } from './useLoading';\nimport { Group, Maybe } from '@backstage-community/plugin-cost-insights-common';\nimport { DefaultLoadingAction } from '../utils/loading';\nimport { useApi, identityApiRef } from '@backstage/core-plugin-api';\nimport { DEFAULT_NAMESPACE, parseEntityRef } from '@backstage/catalog-model';\n\ntype GroupsProviderLoadingProps = {\n  dispatchLoadingGroups: (isLoading: boolean) => void;\n};\n\nconst mapLoadingToProps: MapLoadingToProps<GroupsProviderLoadingProps> = ({\n  dispatch,\n}) => ({\n  dispatchLoadingGroups: (isLoading: boolean) =>\n    dispatch({ [DefaultLoadingAction.UserGroups]: isLoading }),\n});\n\nexport type GroupsContextProps = {\n  groups: Group[];\n};\n\nexport const GroupsContext = React.createContext<\n  GroupsContextProps | undefined\n>(undefined);\n\nexport const GroupsProvider = ({ children }: PropsWithChildren<{}>) => {\n  const identityApi = useApi(identityApiRef);\n  const client = useApi(costInsightsApiRef);\n  const [error, setError] = useState<Maybe<Error>>(null);\n  const { dispatchLoadingGroups } = useLoading(mapLoadingToProps);\n\n  const [groups, setGroups] = useState<Maybe<Group[]>>(null);\n\n  useEffect(() => {\n    dispatchLoadingGroups(true);\n\n    async function getUserGroups() {\n      try {\n        const { userEntityRef } = await identityApi.getBackstageIdentity();\n        const { name: userId } = parseEntityRef(userEntityRef, {\n          defaultKind: 'User',\n          defaultNamespace: DEFAULT_NAMESPACE,\n        });\n        const g = await client.getUserGroups(userId);\n        setGroups(g);\n      } catch (e) {\n        setError(e);\n      } finally {\n        dispatchLoadingGroups(false);\n      }\n    }\n\n    getUserGroups();\n  }, [client]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  if (error) {\n    return <Alert severity=\"error\">{error.message}</Alert>;\n  }\n\n  if (!groups) return null;\n\n  return (\n    <GroupsContext.Provider value={{ groups: groups }}>\n      {children}\n    </GroupsContext.Provider>\n  );\n};\n\nexport function useGroups(): Group[] {\n  const context = useContext(GroupsContext);\n  return context ? context.groups : assertNever();\n}\n\nfunction assertNever(): never {\n  throw Error('Cannot use useGroups outside of GroupsProvider');\n}\n"],"names":[],"mappings":";;;;;;;;AAkCA,MAAM,oBAAmE,CAAC;AAAA,EACxE;AACF,CAAO,MAAA;AAAA,EACL,qBAAA,EAAuB,CAAC,SAAA,KACtB,QAAS,CAAA,EAAE,CAAC,oBAAqB,CAAA,UAAU,GAAG,SAAA,EAAW;AAC7D,CAAA,CAAA;AAMa,MAAA,aAAA,GAAgB,KAAM,CAAA,aAAA,CAEjC,KAAS,CAAA;AAEJ,MAAM,cAAiB,GAAA,CAAC,EAAE,QAAA,EAAsC,KAAA;AACrE,EAAM,MAAA,WAAA,GAAc,OAAO,cAAc,CAAA;AACzC,EAAM,MAAA,MAAA,GAAS,OAAO,kBAAkB,CAAA;AACxC,EAAA,MAAM,CAAC,KAAA,EAAO,QAAQ,CAAA,GAAI,SAAuB,IAAI,CAAA;AACrD,EAAA,MAAM,EAAE,qBAAA,EAA0B,GAAA,UAAA,CAAW,iBAAiB,CAAA;AAE9D,EAAA,MAAM,CAAC,MAAA,EAAQ,SAAS,CAAA,GAAI,SAAyB,IAAI,CAAA;AAEzD,EAAA,SAAA,CAAU,MAAM;AACd,IAAA,qBAAA,CAAsB,IAAI,CAAA;AAE1B,IAAA,eAAe,aAAgB,GAAA;AAC7B,MAAI,IAAA;AACF,QAAA,MAAM,EAAE,aAAA,EAAkB,GAAA,MAAM,YAAY,oBAAqB,EAAA;AACjE,QAAA,MAAM,EAAE,IAAA,EAAM,MAAO,EAAA,GAAI,eAAe,aAAe,EAAA;AAAA,UACrD,WAAa,EAAA,MAAA;AAAA,UACb,gBAAkB,EAAA;AAAA,SACnB,CAAA;AACD,QAAA,MAAM,CAAI,GAAA,MAAM,MAAO,CAAA,aAAA,CAAc,MAAM,CAAA;AAC3C,QAAA,SAAA,CAAU,CAAC,CAAA;AAAA,eACJ,CAAG,EAAA;AACV,QAAA,QAAA,CAAS,CAAC,CAAA;AAAA,OACV,SAAA;AACA,QAAA,qBAAA,CAAsB,KAAK,CAAA;AAAA;AAC7B;AAGF,IAAc,aAAA,EAAA;AAAA,GAChB,EAAG,CAAC,MAAM,CAAC,CAAA;AAEX,EAAA,IAAI,KAAO,EAAA;AACT,IAAA,uBAAQ,KAAA,CAAA,aAAA,CAAA,KAAA,EAAA,EAAM,QAAS,EAAA,OAAA,EAAA,EAAS,MAAM,OAAQ,CAAA;AAAA;AAGhD,EAAI,IAAA,CAAC,QAAe,OAAA,IAAA;AAEpB,EACE,uBAAA,KAAA,CAAA,aAAA,CAAC,cAAc,QAAd,EAAA,EAAuB,OAAO,EAAE,MAAA,MAC9B,QACH,CAAA;AAEJ;AAEO,SAAS,SAAqB,GAAA;AACnC,EAAM,MAAA,OAAA,GAAU,WAAW,aAAa,CAAA;AACxC,EAAO,OAAA,OAAA,GAAU,OAAQ,CAAA,MAAA,GAAS,WAAY,EAAA;AAChD;AAEA,SAAS,WAAqB,GAAA;AAC5B,EAAA,MAAM,MAAM,gDAAgD,CAAA;AAC9D;;;;"}