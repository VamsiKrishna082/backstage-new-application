{"version":3,"file":"useLoading.esm.js","sources":["../../src/hooks/useLoading.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, {\n  createContext,\n  Dispatch,\n  PropsWithChildren,\n  SetStateAction,\n  useContext,\n  useEffect,\n  useMemo,\n  useReducer,\n  useState,\n} from 'react';\nimport Backdrop from '@material-ui/core/Backdrop';\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport { Loading } from '../types';\nimport {\n  DefaultLoadingAction,\n  getDefaultState,\n  INITIAL_LOADING_ACTIONS,\n} from '../utils/loading';\nimport { useBackdropStyles as useStyles } from '../utils/styles';\nimport { useConfig } from './useConfig';\n\nexport type LoadingContextProps = {\n  state: Loading;\n  dispatch: Dispatch<Partial<SetStateAction<Loading>>>;\n  actions: Array<string>;\n};\n\nexport type MapLoadingToProps<T> = (props: LoadingContextProps) => T;\n\nexport const LoadingContext = createContext<LoadingContextProps | undefined>(\n  undefined,\n);\n\nfunction reducer(prevState: Loading, action: Partial<Loading>): Loading {\n  return {\n    ...prevState,\n    ...action,\n  } as Record<string, boolean>;\n}\n\nexport const LoadingProvider = ({ children }: PropsWithChildren<{}>) => {\n  const classes = useStyles();\n  const { products } = useConfig();\n  const actions = useMemo(\n    () =>\n      INITIAL_LOADING_ACTIONS.filter(\n        action =>\n          products.length ||\n          action !== DefaultLoadingAction.CostInsightsProducts,\n      ),\n    [products],\n  );\n  const [state, dispatch] = useReducer(reducer, getDefaultState(actions));\n  const [isBackdropVisible, setBackdropVisible] = useState(false);\n\n  useEffect(() => {\n    function displayLoadingBackdrop() {\n      // Initial page loading is handled by progress bar\n      setBackdropVisible(\n        !state[DefaultLoadingAction.CostInsightsInitial] &&\n          Object.values(state).some(l => l),\n      );\n    }\n    displayLoadingBackdrop();\n  }, [state, setBackdropVisible]);\n\n  return (\n    <LoadingContext.Provider value={{ state, actions, dispatch }}>\n      {children}\n      <Backdrop open={isBackdropVisible} classes={classes}>\n        <CircularProgress />\n      </Backdrop>\n    </LoadingContext.Provider>\n  );\n};\n\nexport function useLoading<T>(mapLoadingToProps: MapLoadingToProps<T>): T {\n  const context = useContext(LoadingContext);\n\n  if (!context) {\n    assertNever();\n  }\n\n  return mapLoadingToProps({\n    state: context.state,\n    actions: context.actions,\n    dispatch: context.dispatch,\n  });\n}\n\nfunction assertNever(): never {\n  throw Error('useLoading cannot be used outside of LoadingProvider');\n}\n"],"names":["useStyles"],"mappings":";;;;;;;AA8CO,MAAM,cAAiB,GAAA,aAAA;AAAA,EAC5B,KAAA;AACF;AAEA,SAAS,OAAA,CAAQ,WAAoB,MAAmC,EAAA;AACtE,EAAO,OAAA;AAAA,IACL,GAAG,SAAA;AAAA,IACH,GAAG;AAAA,GACL;AACF;AAEO,MAAM,eAAkB,GAAA,CAAC,EAAE,QAAA,EAAsC,KAAA;AACtE,EAAA,MAAM,UAAUA,iBAAU,EAAA;AAC1B,EAAM,MAAA,EAAE,QAAS,EAAA,GAAI,SAAU,EAAA;AAC/B,EAAA,MAAM,OAAU,GAAA,OAAA;AAAA,IACd,MACE,uBAAwB,CAAA,MAAA;AAAA,MACtB,CACE,MAAA,KAAA,QAAA,CAAS,MACT,IAAA,MAAA,KAAW,oBAAqB,CAAA;AAAA,KACpC;AAAA,IACF,CAAC,QAAQ;AAAA,GACX;AACA,EAAM,MAAA,CAAC,OAAO,QAAQ,CAAA,GAAI,WAAW,OAAS,EAAA,eAAA,CAAgB,OAAO,CAAC,CAAA;AACtE,EAAA,MAAM,CAAC,iBAAA,EAAmB,kBAAkB,CAAA,GAAI,SAAS,KAAK,CAAA;AAE9D,EAAA,SAAA,CAAU,MAAM;AACd,IAAA,SAAS,sBAAyB,GAAA;AAEhC,MAAA,kBAAA;AAAA,QACE,CAAC,KAAM,CAAA,oBAAA,CAAqB,mBAAmB,CAAA,IAC7C,MAAO,CAAA,MAAA,CAAO,KAAK,CAAA,CAAE,IAAK,CAAA,CAAA,CAAA,KAAK,CAAC;AAAA,OACpC;AAAA;AAEF,IAAuB,sBAAA,EAAA;AAAA,GACtB,EAAA,CAAC,KAAO,EAAA,kBAAkB,CAAC,CAAA;AAE9B,EAAA,2CACG,cAAe,CAAA,QAAA,EAAf,EAAwB,KAAO,EAAA,EAAE,OAAO,OAAS,EAAA,QAAA,MAC/C,QACD,kBAAA,KAAA,CAAA,aAAA,CAAC,YAAS,IAAM,EAAA,iBAAA,EAAmB,2BAChC,KAAA,CAAA,aAAA,CAAA,gBAAA,EAAA,IAAiB,CACpB,CACF,CAAA;AAEJ;AAEO,SAAS,WAAc,iBAA4C,EAAA;AACxE,EAAM,MAAA,OAAA,GAAU,WAAW,cAAc,CAAA;AAEzC,EAAA,IAAI,CAAC,OAAS,EAAA;AACZ,IAAY,WAAA,EAAA;AAAA;AAGd,EAAA,OAAO,iBAAkB,CAAA;AAAA,IACvB,OAAO,OAAQ,CAAA,KAAA;AAAA,IACf,SAAS,OAAQ,CAAA,OAAA;AAAA,IACjB,UAAU,OAAQ,CAAA;AAAA,GACnB,CAAA;AACH;AAEA,SAAS,WAAqB,GAAA;AAC5B,EAAA,MAAM,MAAM,sDAAsD,CAAA;AACpE;;;;"}