{"version":3,"file":"util.cjs.js","sources":["../../src/lib/util.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { GithubTopicFilters } from '../providers/GithubEntityProviderConfig';\n\nexport function parseGithubOrgUrl(urlString: string): { org: string } {\n  const path = new URL(urlString).pathname.slice(1).split('/');\n\n  // /backstage\n  if (path.length === 1 && path[0].length) {\n    return { org: decodeURIComponent(path[0]) };\n  }\n\n  throw new Error(`Expected a URL pointing to /<org>`);\n}\n\nexport function satisfiesTopicFilter(\n  topics: string[],\n  topicFilter: GithubTopicFilters | undefined,\n): Boolean {\n  // We don't want to do anything if a filter is not configured (or configured but empty)\n  if (!topicFilter) return true;\n  if (!topicFilter.include && !topicFilter.exclude) return true;\n  if (!topicFilter.include?.length && !topicFilter.exclude?.length) return true;\n  // If topic.include is in use, a topic MUST be set that matches the inclusion\n  // filter in order for a repository to be ingested\n  if (topicFilter.include?.length && !topicFilter.exclude) {\n    for (const topic of topics) {\n      if (topicFilter.include.includes(topic)) return true;\n    }\n    return false;\n  }\n  // If topic.exclude is in use, all topics are included by default\n  // with anything matching the filter being discarded. It is technically\n  // possible for the filter to be explicitly empty meaning all repositories\n  // are ingested although doing so would be pointless.\n  if (!topicFilter.include && topicFilter.exclude?.length) {\n    if (!topics.length) return true;\n    for (const topic of topics) {\n      if (topicFilter.exclude.includes(topic)) return false;\n    }\n    return true;\n  }\n  // Now the tricky part is where we have both include and exclude configured.\n  // In this case, exclude wins out so we take everything matching the initial\n  // inclusion filter and from that group, we further discard anything matching\n  // the exclusion filter. If an item were to have a topic set in both filters,\n  // we expect it to be discarded in the end. The use case here is that is that\n  // you may want to retrieve all repos with the topic of team-a while excluding\n  // matching repos that are marked as experiments.\n  if (topicFilter.include && topicFilter.exclude) {\n    const matchesInclude = satisfiesTopicFilter(topics, {\n      include: topicFilter.include,\n    });\n    const matchesExclude = !satisfiesTopicFilter(topics, {\n      exclude: topicFilter.exclude,\n    });\n    if (matchesExclude) return false;\n    return matchesInclude;\n  }\n\n  // If the topic filter is somehow ever in a state that is not covered here, we\n  // will fail \"open\" so that Backstage is still usable as if the filter was\n  // not configured at all.\n  return true;\n}\n\nexport function satisfiesForkFilter(\n  allowForks: boolean | true,\n  isFork: boolean | false,\n): Boolean {\n  // we don't want to include forks if forks are not allowed\n  if (!allowForks && isFork) return false;\n\n  // if forks are allowed, allow all repos through\n  return true;\n}\n\n// Given the github organisation team slug, returns a tuple containing [organisation, team]\nexport function splitTeamSlug(slug: string): [string, string] {\n  const parts = slug.split('/');\n  if (parts.length !== 2) {\n    throw new Error(\n      `Github team slug '${slug}' was not in the expected format <organisation>/<team>`,\n    );\n  }\n  return [parts[0], parts[1]];\n}\n\nexport function satisfiesVisibilityFilter(\n  visibilities: string[],\n  visibility: string,\n): Boolean {\n  if (!visibilities.length) {\n    return true;\n  }\n  const lowerCaseVisibilities = visibilities.map(v =>\n    v.toLocaleLowerCase('en-US'),\n  );\n  const lowerCaseVisibility = visibility.toLocaleLowerCase('en-US');\n\n  return lowerCaseVisibilities.includes(lowerCaseVisibility);\n}\n"],"names":[],"mappings":"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"}